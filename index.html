<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JYOTI ITC ROSERA - Official Portal</title>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #004aad; /* Skill India Blue */
            --accent: #f26522; /* Skill India Orange */
            --danger: #d9534f; /* Admin Red */
            --light: #f4f6f9;
            --dark: #333;
            --sidebar-width: 250px;
        }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            background: var(--light); 
            color: var(--dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* HEADER */
        header { background: #fff; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; z-index: 10; }
        .logo-area { display: flex; align-items: center; gap: 15px; }
        .logo-area img { height: 60px; }
        .inst-info h1 { margin: 0; font-size: 1.5rem; color: var(--primary); text-transform: uppercase; }
        .inst-info p { margin: 0; font-size: 0.9rem; color: #666; font-weight: bold; }
        
        /* NAVIGATION */
        .login-nav { display: flex; gap: 10px; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-student { background: var(--primary); color: white; }
        .btn-staff { background: var(--accent); color: white; }
        .btn-admin { background: var(--danger); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        /* MAIN CONTAINER */
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; flex: 1; width: 100%; }
        
        /* ADMIN LAYOUT */
        .admin-wrapper { display: flex; min-height: 80vh; gap: 20px; }
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .sidebar h3 { color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top: 0; }
        .sidebar-btn {
            padding: 12px; text-align: left; background: #f8f9fa; border: 1px solid #ddd;
            cursor: pointer; border-radius: 5px; font-weight: 500; transition: 0.2s;
        }
        .sidebar-btn:hover, .sidebar-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .admin-content { flex: 1; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* NOTICE BOARD */
        .notice-board { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; height: 300px; overflow: hidden; position: relative; }
        .section-title { border-left: 5px solid var(--accent); padding-left: 10px; margin-bottom: 20px; color: var(--primary); }
        .marquee-container { height: 100%; overflow: hidden; position: relative; }
        .marquee-content { position: absolute; width: 100%; animation: scrollUp 15s linear infinite; }
        .marquee-content:hover { animation-play-state: paused; }
        @keyframes scrollUp { 0% { top: 100%; } 100% { top: -150%; } }
        .notice-item { border-bottom: 1px solid #eee; padding: 15px; background: #fafafa; margin-bottom: 5px; border-left: 4px solid var(--primary); }
        .notice-date { font-size: 0.8rem; color: #888; display: block; margin-bottom: 5px; font-weight: bold; }

        /* GENERAL STYLES */
        .director-msg { display: flex; gap: 20px; background: white; padding: 20px; border-radius: 10px; align-items: flex-start; margin-bottom: 30px; }
        .director-img { width: 150px; height: 150px; object-fit: cover; border-radius: 50%; border: 3px solid var(--primary); }
        .trades-section { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
        .trade-card { flex: 1; background: white; padding: 20px; border-radius: 10px; border-top: 5px solid var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.05); min-width: 300px; }
        .trade-card h3 { color: var(--primary); margin-top: 0; }
        
        .panel { display: none; } 
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: var(--primary); color: white; }
        input, select, textarea { width: 90%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin: 5px 0; }
        
        footer { background: var(--dark); color: white; text-align: center; padding: 20px; margin-top: auto; }

        /* EDITABLE CELLS FOR GRADING */
        .editable-cell { background: #fffbe6; cursor: text; }
        .editable-cell:focus { background: #fff; outline: 2px solid var(--primary); }

        /* PRINT STYLES - STRICT */
        @media print {
            body * { visibility: hidden; }
            header, footer, .login-nav, .sidebar, .no-print, #admin-controls, #entry-tools, #admin-filters, #notice-form-area { display: none !important; }
            
            #progress-card-area, #progress-card-area * { visibility: visible; }
            #admin-tool-container, #admin-tool-container * { visibility: visible; }

            #progress-card-area, #admin-tool-container {
                position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white;
            }
            #pc-content { border: 2px solid black !important; width: 98% !important; margin: 0 auto !important; }
            
            table { width: 100%; border: 1px solid black; border-collapse: collapse; }
            th, td { border: 1px solid black !important; color: black !important; padding: 5px; }
            th { -webkit-print-color-adjust: exact; background-color: #eee !important; }
            .editable-cell { background: transparent !important; border: none; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-area">
            <img src="skill.png" alt="Skill India">
            <div class="inst-info">
                <h1>Jyoti ITC Rosera</h1>
                <p>Affiliated by NCVT | Govt of India</p>
                <p>Affiliation No: DGET-6/4/71/2010-TC</p>
                <p style="color:var(--accent);">Contact: 9709506515</p>
            </div>
        </div>
        <div class="login-nav">
            <button class="btn btn-student" onclick="showLogin('student')">Student</button>
            <button class="btn btn-staff" onclick="showLogin('staff')">Staff</button>
            <button class="btn btn-admin" onclick="showLogin('admin')">Admin</button>
            <button class="btn" style="background:#333; color:white;" onclick="location.reload()">Home</button>
        </div>
    </header>

    <div id="home-section" class="container">
        <div class="trades-section">
            <div class="trade-card">
                <h3>üõ†Ô∏è Fitter (NSQF Level 5)</h3>
                <p><strong>Speciality:</strong> Mechanical fitting, Pipe fitting, Lathe operation, Welding basics.</p>
                <p>Duration: 2 Years | Eligibility: 10th Pass</p>
            </div>
            <div class="trade-card">
                <h3>‚ö° Electrician (NSQF Level 5)</h3>
                <p><strong>Speciality:</strong> House wiring, Motor winding, Power generation, Transformer maintenance.</p>
                <p>Duration: 2 Years | Eligibility: 10th Pass</p>
            </div>
        </div>
        <br>
        <div class="notice-board">
            <h2 class="section-title">üì¢ Notice Board</h2>
            <div class="marquee-container">
                <div id="notice-container" class="marquee-content">Loading notices...</div>
            </div>
        </div>
        <div class="director-msg">
            <img src="director.JPG" alt="Director" class="director-img">
            <div>
                <h2 style="margin-top:0;">Director's Message</h2>
                <p>"Welcome to Jyoti ITC. We are committed to providing world-class technical education to empower the youth of Bihar..."</p>
                <p><strong>- Director Name</strong></p>
            </div>
        </div>
        <h2 class="section-title" style="margin-top:10px;">üñºÔ∏è Gallery</h2>
        <div style="display:flex; gap:5px; overflow-x:auto; padding-bottom:5px;">
            <img src="jyoti-picture.jpg" style="border-radius:5px;">
            <img src="classroom.jpeg" style="border-radius:5px;">
            <img src="jyotilab.jpg" style="border-radius:5px;">
        </div>
    </div>

    <div id="student-panel" class="container panel">
        <h2>üë®‚Äçüéì Student Dashboard <span id="st-name-display" style="font-size:0.8em; color:gray;"></span></h2>
        <div class="notice-board" style="height:auto;">
            <h3>üìö Study Material / Question Bank</h3>
            <table id="material-table">
                <thead><tr><th>Year</th><th>Trade</th><th>Subject</th><th>Download</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="staff-panel" class="container panel">
        <h2>üë®‚Äçüè´ Staff Dashboard</h2>
        <div class="admin-wrapper">
            <div class="sidebar">
                <h3>Menu</h3>
                <div class="sidebar-btn active" onclick="openEntryTool('attendance')">üìù Mark Attendance</div>
            </div>
            <div class="admin-content">
                <div id="staff-entry-area">
                    <h3>Welcome Staff</h3>
                    <p>Please use the menu to mark attendance.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="container panel">
        <h2>üîí Admin Dashboard</h2>
        
        <div class="admin-wrapper">
            <div class="sidebar no-print">
                <h3>Data Entry</h3>
                <div class="sidebar-btn" onclick="openEntryTool('monthly')">üìä Monthly Marks</div>
                <div class="sidebar-btn" onclick="openEntryTool('quarterly')">üìà Quarterly Marks</div>
                <div class="sidebar-btn" onclick="openEntryTool('job')">üõ†Ô∏è Job Evolution</div>
                <div class="sidebar-btn" onclick="openAdminTool('notice')">üì¢ Publish Notice</div>
                
                <h3>History & Reports</h3>
                <div class="sidebar-btn" onclick="openAdminTool('history_attendance')">Attendance History</div>
                <div class="sidebar-btn" onclick="openAdminTool('history_monthly')">Monthly Marks History</div>
                <div class="sidebar-btn" onclick="openAdminTool('history_quarterly')">Quarterly Marks History</div>
                <div class="sidebar-btn" onclick="openAdminTool('history_job')">Job Evolution History</div>
                
                <h3>Progress Cards</h3>
                <div class="sidebar-btn" onclick="setupProgressCard('Fitter')">üñ®Ô∏è Fitter Card</div>
                <div class="sidebar-btn" onclick="setupProgressCard('Electrician')">üñ®Ô∏è Electrician Card</div>

                <h3>Settings</h3>
                <div class="sidebar-btn" style="background:#ffebee;" onclick="openSettings()">‚öôÔ∏è Change Password</div>
            </div>

            <div class="admin-content">
                
                <div id="entry-tool-container" style="display:none;">
                    <h3 id="tool-title" style="color:var(--primary); border-bottom:2px solid var(--accent); padding-bottom:5px;">Tool Name</h3>
                    <div style="margin-bottom:15px; background:#f9f9f9; padding:10px; border-radius:5px;">
                        
                        <div id="date-input-div" style="display:inline-block;">
                            <label>Date:</label> <input type="date" id="tool-date" style="width:130px;">
                        </div>
                        <div id="month-input-div" style="display:none;">
                            <label>Month:</label> 
                            <select id="tool-month" style="width:130px;">
                                <option>January</option><option>February</option><option>March</option><option>April</option>
                                <option>May</option><option>June</option><option>July</option><option>August</option>
                                <option>September</option><option>October</option><option>November</option><option>December</option>
                            </select>
                        </div>
                        <div id="week-input-div" style="display:none;">
                            <label>Week No:</label> 
                            <select id="tool-week" style="width:100px;">
                                </select>
                        </div>

                        <label>Trade:</label> <select id="tool-trade" style="width:100px;"><option value="Fitter">Fitter</option><option value="Electrician">Electrician</option></select>
                        <label>Unit:</label> <select id="tool-unit" style="width:60px;"><option value="1">1</option><option value="2">2</option></select>
                        <button class="btn btn-staff" onclick="loadStudentListForTool()">Load Students</button>
                    </div>
                    <form id="data-entry-form">
                        <div style="overflow-x:auto;"><table id="entry-table"></table></div>
                        <br><button type="button" class="btn btn-student" onclick="submitStaffData()">FINAL SUBMIT</button>
                    </form>
                </div>

                <div id="admin-tool-container" style="display:none;">
                    <div class="no-print" style="display:flex; justify-content:space-between;">
                        <h3 id="history-title">History</h3>
                        <button class="btn btn-staff" onclick="window.print()">Print Report</button>
                    </div>
                    
                    <div id="admin-filters" class="no-print" style="margin-bottom:15px;">
                        <label>Trade:</label> <select id="admin-trade" style="width:120px;"><option value="Fitter">Fitter</option><option value="Electrician">Electrician</option></select>
                        <label>Unit:</label> <select id="admin-unit" style="width:80px;"><option value="1">1</option><option value="2">2</option></select>
                        
                        <span id="history-date-span" style="display:none;">
                            <label>Date:</label> <input type="date" id="history-date">
                        </span>
                        
                        <span id="history-month-span" style="display:none;">
                            <label>Month:</label> 
                            <select id="history-month" style="width:130px;">
                                <option>January</option><option>February</option><option>March</option><option>April</option>
                                <option>May</option><option>June</option><option>July</option><option>August</option>
                                <option>September</option><option>October</option><option>November</option><option>December</option>
                            </select>
                        </span>

                        <span id="history-week-span" style="display:none;">
                            <label>Week:</label> 
                            <select id="history-week" style="width:100px;">
                                </select>
                        </span>

                        <button class="btn btn-admin" onclick="loadAdminHistory()">Load Data</button>
                    </div>

                    <div id="notice-form-area" style="display:none;" class="no-print">
                        <input type="text" id="notice-title" placeholder="Title">
                        <textarea id="notice-content" rows="4" placeholder="Content..."></textarea>
                        <br><br><button class="btn btn-admin" onclick="publishNotice()">Publish</button>
                    </div>

                    <div id="admin-result-area" style="overflow-x:auto;"></div>
                </div>

                <div id="progress-card-area" style="display:none;">
                    <div class="no-print" style="background:#ddd; padding:10px; border-radius:5px; margin-bottom:20px;">
                        <label>Roll No:</label> <input type="number" id="pc-roll" placeholder="Ex: 5" style="width:100px;">
                        <button class="btn btn-admin" onclick="generateProgressCard()">Generate</button>
                        <button class="btn btn-student" onclick="window.print()">PRINT</button>
                    </div>
                    
                    <div id="pc-content" style="border:2px solid black; padding:20px; max-width:800px; margin:auto;">
                        <div style="text-align:center; border-bottom:2px solid black; padding-bottom:10px; margin-bottom:15px;">
                            <h2 style="margin:0; text-transform:uppercase;">Jyoti Private I.T.I</h2>
                            <p style="margin:5px 0;">Rosera, Samastipur | Affiliation No: DGET-6/4/71/2010-TC</p>
                            <h3 style="margin:10px 0; text-decoration:underline;">PROGRESS CARD</h3>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <div style="width:48%;"><strong>Name:</strong> <span id="pc-name" style="border-bottom:1px dotted #000; padding:0 10px;">Loading...</span></div>
                            <div style="width:48%;"><strong>Trade:</strong> <span id="pc-trade" style="border-bottom:1px dotted #000; padding:0 10px;">FITTER</span></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                            <div style="width:48%;"><strong>Roll No:</strong> <span id="pc-roll-display" style="border-bottom:1px dotted #000; padding:0 10px;"></span></div>
                            <div style="width:48%;"><strong>Session:</strong> 2024-26</div>
                        </div>
                        <table id="pc-table" style="width:100%; border:1px solid black; font-size:12px;">
                            <thead>
                                <tr style="background:#eee;">
                                    <th style="width:50px;">Week</th>
                                    <th>Exercise Done during the week</th>
                                    <th style="width:60px;">Grade</th>
                                    <th style="width:80px;">Inst. Sign</th>
                                    <th style="width:80px;">Remark</th>
                                </tr>
                            </thead>
                            <tbody id="pc-tbody"></tbody>
                        </table>
                        <div style="margin-top:40px; display:flex; justify-content:space-between;">
                            <div style="text-align:center;"><br>___________________<br>Trade Instructor</div>
                            <div style="text-align:center;"><br>___________________<br>Principal</div>
                        </div>
                    </div>
                </div>

                <div id="settings-area" style="display:none;" class="no-print">
                    <h3>‚öôÔ∏è Change Credentials</h3>
                    <div style="background:#f9f9f9; padding:20px; border-radius:10px;">
                        <h4>Admin Login</h4>
                        <input type="text" id="new-admin-id" placeholder="New Admin ID">
                        <input type="text" id="new-admin-pass" placeholder="New Admin Password">
                        <hr>
                        <h4>Staff Login</h4>
                        <input type="text" id="new-staff-id" placeholder="New Staff ID">
                        <input type="text" id="new-staff-pass" placeholder="New Staff Password">
                        <br><br>
                        <button class="btn btn-admin" onclick="saveCredentials()">Save Changes</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="login-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:10px; width:300px; text-align:center;">
            <h3 id="login-title">Login</h3>
            <input type="text" id="login-id" placeholder="ID" style="margin-bottom:10px;">
            <input type="password" id="login-pass" placeholder="Password" style="margin-bottom:10px;">
            <button class="btn btn-primary" onclick="processLogin()">Login</button>
            <button class="btn" style="background:#ccc;" onclick="document.getElementById('login-modal').style.display='none'">Close</button>
        </div>
    </div>

    <footer>
        <p>JYOTI ITC ROSERA | Contact: 9709506515 | Affiliation: DGET-6/4/71/2010-TC</p>
        <p>Address: Rosera, Samastipur | &copy; 2026 All Rights Reserved</p>
    </footer>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxYHjteHyOpRY8oqwLOR74yJv64SdDuG-pGjHyOlgY7bTX4Ww_zVt9bckoyi9Hgri0QsA/exec";

        const FITTER_EXERCISES = {
            1: "IMPORTANCE OF TRADE TRAINING, LIST OF TOOLS & MACHINERY", 2: "SAFETY ATTITUDE DEVELOPMENT & PPE", 3: "FIRST AID METHOD AND BASIC TRAINING", 4: "SAFE DISPOSAL OF WASTE MATERIALS", 5: "HAZARD IDENTIFICATION AND AVOIDANCE", 6: "SAFETY SIGN", 7: "PREVENTIVE MEASURES FOR ELECTRICAL ACCIDENTS", 8: "USES OF FIRE EXTINGUISHERS", 9: "DETAIL OF BENCH VICE, ANVIL, AND GRINDING MACHINE", 10: "SAFE USE OF TOOLS AND EQUIPMENTS", 11: "IDENTIFICATION OF TOOLS FOR MARKING & SAWING", 12: "MARKING OUT LINES, GRIPPING, HACKSAWING", 13: "SAWING DIFFERENT TYPES OF METALS", 14: "FILING CHANNEL, PARALLEL", 15: "FILING FLAT AND SQUARE (ROUGH FINISH)", 16: "MARKING PRACTICE WITH DIVIDERS, ODD LEG CALIPERS", 17: "MARKING, FILING, FLAT SQUARE AND CHECK USING TRY-SQUARE", 18: "FINDING CENTER OF ROUND BAR ('V' BLOCK)", 19: "CHIPPING, CHAMFERING, CHIP SLOTS AND OIL GROOVES", 20: "FILE STEPS AND FINISH WITH SMOOTH FILE", 21: "FILE RADIUS ALONG A MARKED LINE", 22: "MARK OFF AND DRILL THROUGH HOLE", 23: "DRILL AND TAP ON M.S. FLAT", 24: "PRACTICE USE OF DIFFERENT PUNCHES", 25: "MARKING GEOMETRICAL SHAPES & CUTTING WITH SNIPS", 26: "PUNCH HOLES USING HOLLOW AND SOLID PUNCHES", 27: "DO LAP AND BUTT JOINTS", 28: "DRILL FOR RIVETING", 29: "MARK OFF AND DRILL THROUGH HOLES", 30: "DRILL ON M.S FLAT", 31: "FILE RADIUS AND PROFILE TO SUIT GAUGE", 32: "DRILL THROUGH HOLE AND BLIND HOLES", 33: "FILE AND MAKE STEP FIT, ANGULAR FIT", 34: "MAKE SIMPLE OPEN AND SLIDING FITS", 35: "MAKE OPEN FITTING OF CURVED PROFILES", 36: "MAKE INSIDE SQUARE FIT", 37: "FILE FIT - COMBINED, OPEN ANGULAR AND SLIDING", 38: "File internal angles 30 minutes accuracy", 39: "Scrap on flat surfaces and curved surfaces", 40: "H FITTING", 41: "Precision drilling, reaming and tapping", 42: "Make dovetailed fitting and radius fitting", 43: "Make sliding diamond fitting", 44: "Scrape on internal surface and check", 45: "Fitter - Pipes and pipe fittings", 46: "Dovetail and dowel pin assembly", 47: "Make sliding fits assembly", 48: "Make open fitting of curved profiles", 49: "Form internal threads with taps to standard size", 50: "Shoulder turn : Square, filleted, beveled", 51: "Sharpening of - single point tools", 52: "Cut grooves - square, round V groove", 53: "MAKE A MANDREL - TURN DIAMETER", 54: "KNURL THE JOB", 55: "MAKE A BUSH STEP BORE-CUT RECESS", 56: "TURN TAPER (INTERNAL AND EXTERNAL)", 57: "TURN STANDARD TAPERS TO SUIT WITH GAUGE", 58: "PRACTICE THREADING USING TAPS, DIES ON LATHE", 59: "READ PRESSURE GAUGE, TEMPERATURE GAUGE", 60: "FACING AND CHAMFRING PRACTICE", 61: "STEP TURNING PRACTICE (DOUBLE EDGE)", 62: "PIPE BENDING BY CODED HEATING", 63: "THREADING ON ROUND ROD", 64: "SQUARE ANGULAR MARKING AND FILING", 65: "KEY WAY AND SLOTS MARKING PRACTICE", 66: "INTERNAL DOUBLE SQUARE FITTING", 67: "EXTERNAL, INTERNAL, RADIUS FITTING", 68: "AN INTERNAL CROSS FITTING", 69: "SLIDING FITTING", 70: "INTERNAL HEAD AND TAIL FITTING", 71: "STAR MARKING PRACTICE", 72: "INTERNAL STAR FITTING PRACTICE", 73: "FASTEN MECHANICAL COMPONENTS", 74: "MARKING AN OIL SLOT", 75: "MAKING TRIANGULAR FITTING", 76: "MAKING DOUBLE SQUARE AND RADIUS FITTING"
        };
        const ELECT_EXERCISES = {}; 
        for(let i=1; i<=76; i++) ELECT_EXERCISES[i] = "Electrician Exercise " + i;

        // Initialize Week Numbers in Entry & History
        const weekSelectEntry = document.getElementById('tool-week');
        const weekSelectHistory = document.getElementById('history-week');
        
        for(let i=1; i<=76; i++) {
            let opt1 = document.createElement('option');
            opt1.value = i;
            opt1.innerText = "Week " + i;
            weekSelectEntry.appendChild(opt1);

            let opt2 = document.createElement('option');
            opt2.value = i;
            opt2.innerText = "Week " + i;
            weekSelectHistory.appendChild(opt2);
        }

        window.onload = function() { 
            fetchNotices(); 
            if(!localStorage.getItem('adminCreds')) localStorage.setItem('adminCreds', JSON.stringify({id:'admin', pass:'12345'}));
            if(!localStorage.getItem('staffCreds')) localStorage.setItem('staffCreds', JSON.stringify({id:'staff', pass:'12345'}));
        };

        function fetchNotices() {
            fetch(API_URL + "?action=get_notices").then(res => res.json()).then(data => {
                let html = "";
                data.forEach(n => html += `<div class="notice-item"><span class="notice-date">${n.date} [${n.type}]</span>${n.content}</div>`);
                document.getElementById('notice-container').innerHTML = html;
            });
        }

        let currentUserType = null;
        function showLogin(type) {
            currentUserType = type;
            document.getElementById('login-modal').style.display = 'flex';
            document.getElementById('login-title').innerText = type.toUpperCase() + " LOGIN";
        }

        function processLogin() {
            const id = document.getElementById('login-id').value;
            const pass = document.getElementById('login-pass').value;
            
            const adminCreds = JSON.parse(localStorage.getItem('adminCreds'));
            const staffCreds = JSON.parse(localStorage.getItem('staffCreds'));

            if(currentUserType === 'staff' || currentUserType === 'admin') {
                if(currentUserType === 'admin' && id === adminCreds.id && pass === adminCreds.pass) {
                    loginSuccess('admin');
                } else if(currentUserType === 'staff' && id === staffCreds.id && pass === staffCreds.pass) {
                    loginSuccess('staff');
                } else {
                    alert('Invalid Credentials');
                }
            } else {
                fetch(API_URL + `?action=student_login&roll=${id}&pass=${pass}`).then(res => res.json()).then(data => {
                    if(data.status === 'success') {
                        document.getElementById('login-modal').style.display = 'none';
                        document.getElementById('home-section').style.display = 'none';
                        document.getElementById('student-panel').style.display = 'block';
                        document.getElementById('st-name-display').innerText = `(${data.user.name})`;
                        loadStudyMaterial();
                    } else { alert('Invalid Login'); }
                });
            }
        }

        function loginSuccess(role) {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('home-section').style.display = 'none';
            if(role === 'staff') document.getElementById('staff-panel').style.display = 'block';
            else document.getElementById('admin-panel').style.display = 'block';
        }

        function openSettings() {
            hideAllAdminSections();
            document.getElementById('settings-area').style.display = 'block';
            const ac = JSON.parse(localStorage.getItem('adminCreds'));
            const sc = JSON.parse(localStorage.getItem('staffCreds'));
            document.getElementById('new-admin-id').value = ac.id;
            document.getElementById('new-admin-pass').value = ac.pass;
            document.getElementById('new-staff-id').value = sc.id;
            document.getElementById('new-staff-pass').value = sc.pass;
        }

        function saveCredentials() {
            const aid = document.getElementById('new-admin-id').value;
            const apass = document.getElementById('new-admin-pass').value;
            const sid = document.getElementById('new-staff-id').value;
            const spass = document.getElementById('new-staff-pass').value;
            if(aid && apass && sid && spass) {
                localStorage.setItem('adminCreds', JSON.stringify({id: aid, pass: apass}));
                localStorage.setItem('staffCreds', JSON.stringify({id: sid, pass: spass}));
                alert("Credentials Updated! Please login again.");
                location.reload();
            } else {
                alert("All fields are required");
            }
        }

        /* --- UNIFIED PANEL LOGIC --- */
        let activeTool = "";
        
        function hideAllAdminSections() {
            document.getElementById('entry-tool-container').style.display = 'none';
            document.getElementById('admin-tool-container').style.display = 'none';
            document.getElementById('progress-card-area').style.display = 'none';
            document.getElementById('settings-area').style.display = 'none';
        }

        // 1. DATA ENTRY
        function openEntryTool(tool) {
            activeTool = tool;
            if(currentUserType === 'staff') {
                document.getElementById('staff-entry-area').innerHTML = document.getElementById('entry-tool-container').innerHTML;
                document.getElementById('staff-entry-area').style.display = 'block';
            } else {
                hideAllAdminSections();
                document.getElementById('entry-tool-container').style.display = 'block';
            }
            
            let title = "";
            const container = currentUserType === 'staff' ? document.getElementById('staff-panel') : document.getElementById('admin-panel');
            
            container.querySelector('#date-input-div').style.display = 'none';
            container.querySelector('#month-input-div').style.display = 'none';
            container.querySelector('#week-input-div').style.display = 'none';

            if(tool === 'attendance') {
                title = "Attendance Entry";
                container.querySelector('#date-input-div').style.display = 'inline-block';
            }
            else if(tool === 'monthly') {
                title = "Monthly Marks Entry";
                container.querySelector('#month-input-div').style.display = 'inline-block';
            }
            else if(tool === 'quarterly') {
                title = "Quarterly Marks Entry";
                container.querySelector('#month-input-div').style.display = 'inline-block';
            }
            else if(tool === 'job') {
                title = "Job Evolution Entry";
                container.querySelector('#week-input-div').style.display = 'inline-block';
            }
            
            container.querySelector('#tool-title').innerText = title;
            container.querySelector('#entry-table').innerHTML = ''; 
        }

        // 2. HISTORY & NOTICE
        let adminAction = "";
        function openAdminTool(action) {
            adminAction = action;
            hideAllAdminSections();
            document.getElementById('admin-tool-container').style.display = 'block';
            document.getElementById('admin-result-area').innerHTML = "";
            
            // Hide all filter inputs first
            document.getElementById('history-date-span').style.display = 'none';
            document.getElementById('history-month-span').style.display = 'none';
            document.getElementById('history-week-span').style.display = 'none';
            
            if(action === 'notice') {
                document.getElementById('admin-filters').style.display = 'none';
                document.getElementById('notice-form-area').style.display = 'block';
                document.getElementById('history-title').innerText = "Publish Notice";
            } else {
                document.getElementById('admin-filters').style.display = 'block';
                document.getElementById('notice-form-area').style.display = 'none';
                document.getElementById('history-title').innerText = action.replace('history_', '').toUpperCase();
                
                if(action === 'history_attendance') {
                    document.getElementById('history-date-span').style.display = 'inline-block';
                }
                else if(action === 'history_monthly' || action === 'history_quarterly') {
                    document.getElementById('history-month-span').style.display = 'inline-block';
                }
                else if(action === 'history_job') {
                    document.getElementById('history-week-span').style.display = 'inline-block';
                }
            }
        }

        // 3. PROGRESS CARD
        let selectedTradeForPC = "";
        function setupProgressCard(trade) {
            selectedTradeForPC = trade;
            hideAllAdminSections();
            document.getElementById('progress-card-area').style.display = 'block';
            document.getElementById('pc-trade').innerText = trade.toUpperCase();
            document.getElementById('pc-tbody').innerHTML = "";
        }

        /* --- LOGIC FUNCTIONS --- */
        function loadStudentListForTool() {
            const container = currentUserType === 'staff' ? document.getElementById('staff-panel') : document.getElementById('admin-panel');
            const trade = container.querySelector('#tool-trade').value;
            const unit = container.querySelector('#tool-unit').value;
            fetch(API_URL + `?action=get_class_list&trade=${trade}&unit=${unit}`)
            .then(res => res.json())
            .then(students => {
                const table = container.querySelector('#entry-table');
                let thead = "", rows = "";
                if(activeTool === 'attendance') {
                    thead = `<thead><tr><th>Roll</th><th>Name</th><th>Status</th></tr></thead>`;
                    students.forEach(s => rows += `<tr class="data-row" data-roll="${s.roll}" data-name="${s.name}" data-trade="${s.trade}" data-unit="${s.unit}"><td>${s.roll}</td><td>${s.name}</td><td><select class="inp-status"><option value="P">Present</option><option value="A">Absent</option></select></td></tr>`);
                } else if(activeTool === 'monthly' || activeTool === 'quarterly') {
                    thead = `<thead><tr><th>Roll</th><th>Name</th><th>Prac(50)</th><th>Thry(20)</th><th>ED(20)</th><th>WCS(10)</th><th>Total</th></tr></thead>`;
                    students.forEach(s => rows += `<tr class="data-row" data-roll="${s.roll}" data-name="${s.name}" data-trade="${s.trade}" data-unit="${s.unit}"><td>${s.roll}</td><td>${s.name}</td><td><input type="number" class="m-prac" oninput="calcTotal(this)"></td><td><input type="number" class="m-thry" oninput="calcTotal(this)"></td><td><input type="number" class="m-ed" oninput="calcTotal(this)"></td><td><input type="number" class="m-wcs" oninput="calcTotal(this)"></td><td><input type="text" class="m-total" readonly></td></tr>`);
                } else if(activeTool === 'job') {
                    thead = `<thead><tr><th>Roll</th><th>Name</th><th>A(10)</th><th>B(15)</th><th>C(8)</th><th>D(7)</th><th>E(10)</th><th>Total</th></tr></thead>`;
                    students.forEach(s => rows += `<tr class="data-row" data-roll="${s.roll}" data-name="${s.name}" data-trade="${s.trade}" data-unit="${s.unit}"><td>${s.roll}</td><td>${s.name}</td><td><input type="number" class="j-a" oninput="calcJobTotal(this)"></td><td><input type="number" class="j-b" oninput="calcJobTotal(this)"></td><td><input type="number" class="j-c" oninput="calcJobTotal(this)"></td><td><input type="number" class="j-d" oninput="calcJobTotal(this)"></td><td><input type="number" class="j-e" oninput="calcJobTotal(this)"></td><td><input type="text" class="j-total" readonly></td></tr>`);
                }
                table.innerHTML = thead + `<tbody>${rows}</tbody>`;
            });
        }

        function calcTotal(elem) {
            const row = elem.closest('tr');
            const val = (cls) => Number(row.querySelector(cls).value) || 0;
            row.querySelector('.m-total').value = val('.m-prac') + val('.m-thry') + val('.m-ed') + val('.m-wcs');
        }
        function calcJobTotal(elem) {
            const row = elem.closest('tr');
            const val = (cls) => Number(row.querySelector(cls).value) || 0;
            row.querySelector('.j-total').value = val('.j-a') + val('.j-b') + val('.j-c') + val('.j-d') + val('.j-e');
        }

        function submitStaffData() {
            const container = currentUserType === 'staff' ? document.getElementById('staff-panel') : document.getElementById('admin-panel');
            const rows = container.querySelectorAll('.data-row');
            let payload = { type: "", entries: [] };

            if(activeTool === 'attendance') {
                const date = container.querySelector('#tool-date').value;
                if(!date) { alert("Select Date"); return; }
                payload.type = "attendance";
                rows.forEach(r => payload.entries.push([date, r.dataset.roll, r.dataset.name, r.dataset.trade, r.dataset.unit, r.querySelector('.inp-status').value]));
            } 
            else if(activeTool === 'monthly') {
                const month = container.querySelector('#tool-month').value;
                payload.type = "monthly_marks";
                rows.forEach(r => payload.entries.push([month, r.dataset.roll, r.dataset.name, "Monthly", month, r.querySelector('.m-prac').value, r.querySelector('.m-thry').value, r.querySelector('.m-wcs').value, r.querySelector('.m-ed').value, r.querySelector('.m-total').value]));
            } 
            else if(activeTool === 'quarterly') {
                const month = container.querySelector('#tool-month').value;
                payload.type = "quarterly_marks";
                rows.forEach(r => payload.entries.push([month, r.dataset.roll, r.dataset.name, "Quarterly", "Q1", r.querySelector('.m-prac').value, r.querySelector('.m-thry').value, r.querySelector('.m-wcs').value, r.querySelector('.m-ed').value, r.querySelector('.m-total').value]));
            } 
            else if(activeTool === 'job') {
                const week = container.querySelector('#tool-week').value;
                payload.type = "job_marks";
                rows.forEach(r => payload.entries.push([r.dataset.roll, r.dataset.name, r.dataset.trade, r.dataset.unit, "Week " + week, r.querySelector('.j-a').value, r.querySelector('.j-b').value, r.querySelector('.j-c').value, r.querySelector('.j-d').value, r.querySelector('.j-e').value, r.querySelector('.j-total').value, ""]));
            }
            sendData(payload);
        }

        function loadAdminHistory() {
            let sheetName = "";
            if(adminAction === 'history_attendance') sheetName = "ATTENDANCE";
            else if(adminAction === 'history_monthly') sheetName = "MONTHLY MARKS";
            else if(adminAction === 'history_quarterly') sheetName = "QUARTERLY MARKS";
            else if(adminAction === 'history_job') sheetName = "JOB EVOLUTION";

            const trade = document.getElementById('admin-trade').value;
            const unit = document.getElementById('admin-unit').value;
            const histDate = document.getElementById('history-date').value;
            const histMonth = document.getElementById('history-month').value;
            const histWeek = document.getElementById('history-week').value;

            document.getElementById('admin-result-area').innerText = "Loading...";

            fetch(API_URL + `?action=get_sheet_data&sheet_name=${sheetName}`)
            .then(res => res.json())
            .then(data => {
                if(!data || data.length === 0) { document.getElementById('admin-result-area').innerText = "No Data"; return; }
                
                let headers = data[0];
                let table = `<table border="1"><thead><tr>`;
                headers.forEach(h => table += `<th>${h}</th>`);
                table += `</tr></thead><tbody>`;

                for(let i=1; i<data.length; i++) {
                    let row = data[i];
                    let rowString = JSON.stringify(row);
                    let match = true;
                    
                    if(sheetName === 'ATTENDANCE' || sheetName === 'JOB EVOLUTION') {
                        if(!rowString.includes(trade) || !rowString.includes(unit)) match = false;
                    }

                    if(sheetName === 'ATTENDANCE' && histDate) {
                        let rowDate = new Date(row[0]);
                        let filterDate = new Date(histDate);
                        if(row[0] !== histDate) {
                             if(rowDate.toDateString() !== filterDate.toDateString()) match = false;
                        }
                    }
                    
                    // MONTHLY & QUARTERLY FILTER
                    if((sheetName === 'MONTHLY MARKS' || sheetName === 'QUARTERLY MARKS') && histMonth) {
                        // Check if row matches selected month
                        if(!rowString.includes(histMonth)) match = false;
                    }

                    // JOB EVOLUTION FILTER
                    if(sheetName === 'JOB EVOLUTION' && histWeek) {
                        // Check for "Week X"
                        if(!rowString.includes("Week " + histWeek)) match = false;
                    }

                    if(match) {
                        table += `<tr>`;
                        row.forEach(cell => table += `<td>${cell}</td>`);
                        table += `</tr>`;
                    }
                }
                table += `</tbody></table>`;
                document.getElementById('admin-result-area').innerHTML = table;
            });
        }

        function generateProgressCard() {
            const roll = document.getElementById('pc-roll').value;
            if(!roll) { alert("Enter Roll No"); return; }
            document.getElementById('pc-roll-display').innerText = roll;
            document.getElementById('pc-name').innerText = "Searching...";
            
            Promise.all([
                fetch(API_URL + `?action=get_class_list&trade=${selectedTradeForPC}&unit=1`).then(r=>r.json()),
                fetch(API_URL + `?action=get_class_list&trade=${selectedTradeForPC}&unit=2`).then(r=>r.json())
            ]).then(([unit1, unit2]) => {
                const allStudents = [...unit1, ...unit2];
                const student = allStudents.find(s => s.roll == roll);
                if(student) {
                    document.getElementById('pc-name').innerText = student.name;
                    let html = "";
                    let exercises = selectedTradeForPC === 'Fitter' ? FITTER_EXERCISES : ELECT_EXERCISES;
                    for(let w=1; w<=76; w++) {
                        let exName = exercises[w] || "";
                        html += `<tr>
                            <td>${w}</td>
                            <td style="text-align:left; padding-left:5px;">${exName}</td>
                            <td contenteditable="true" class="editable-cell"></td>
                            <td contenteditable="true" class="editable-cell"></td>
                            <td contenteditable="true" class="editable-cell"></td>
                        </tr>`;
                    }
                    document.getElementById('pc-tbody').innerHTML = html;
                } else {
                    document.getElementById('pc-name').innerText = "Student Not Found";
                    alert("Student not found in " + selectedTradeForPC + " lists.");
                }
            });
        }

        function publishNotice() {
            const t = document.getElementById('notice-title').value;
            const c = document.getElementById('notice-content').value;
            if(!t || !c) return alert("Empty");
            sendData({type:"notice", title:t, content:c});
        }

        function sendData(payload) {
            fetch(API_URL, { method: "POST", body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(data => { alert("Saved!"); document.getElementById('data-entry-form').reset(); })
            .catch(err => alert("Error: " + err));
        }
        
        function loadStudyMaterial() {
             fetch(API_URL + "?action=get_study_material").then(res=>res.json()).then(data=>{
                 let h=""; data.forEach(i=>h+=`<tr><td>${i.year}</td><td>${i.trade}</td><td>${i.subject}</td><td><a href="${i.link}">Download</a></td></tr>`);
                 document.querySelector('#material-table tbody').innerHTML=h;
             });
        }
    </script>
</body>
</html>


